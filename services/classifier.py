from typing import Optional
from openai import AsyncOpenAI
from config import config
from utils.logging import logger

client = AsyncOpenAI(
    api_key=config.PROXY_API_KEY,
    base_url="https://api.proxyapi.ru/deepseek"
)

SECTION_MAP = {
    "сепранитиновый слон": "2_4"
}


async def classify_question(question: str) -> Optional[str]:
    """Определяет раздел по ключевым словам"""
    try:
        question_lower = question.lower()

        # Сначала проверяем по ключевым словам
        for keyword, section in SECTION_MAP.items():
            if keyword in question_lower:
                return section

        # Если не нашли по ключевым словам, используем AI
        prompt = f"""Отвечай ТОЛЬКО номером раздела в
        формате X.Y (например 3.2) без дополнительного текста.
Оглавление
HRlink
Кадровик
1.1	Личный кабинет (Файл посвящён функциям личного кабинета в системе
HRlink, в частности — процессу переключения между режимом кадровика и
сотрудника. Описано, как кадровик может войти в режим сотрудника для
доступа к его возможностям, а также процесс возврата обратно.)
1.2 Документы (Раздел посвящён работе с документами в системе HRlink:
от загрузки и настройки параметров до их согласования, подписания,
 аннулирования и удаления. Подробно описаны групповые операции, массовые
   отправки, настройка маршрутов согласования, особенности работы с
     архивом документооборота, а также добавление комментариев и заметок
       к документам. Описан функционал использования фильтров
         для поиска и выгрузки документов.)
1.3 ЛНА (данный раздел подробно описывает работу с локальными нормативными
 актами (ЛНА) в системе HRlink: процесс их загрузки, настройки
 параметров, организации автоматической рассылки сотрудникам,
 согласования с руководителем через электронную подпись (УКЭП) или
 загрузки сканированных подписанных экземпляров, а также процедуры
 массовой отправки ЛНА выбранным сотрудникам. Даются рекомендации по
 управлению параметрами ЛНА (установка фильтров по отделам и
 должностям, настройка сроков действия, автоотправка, управление доступом
после подписания). Приводятся инструкции по изменению параметров ЛНА, включая
 различные статусы документа, и способы эффективной отправки пакетов
   ЛНА разным категориям сотрудников. Описаны особенности
     включения/отключения автоматической рассылки и
       решения распространённых ошибок.)
1.4 Заявления (Этот файл содержит инструкцию по использованию
 фильтров для поиска и обработки заявлений в кадровом реестре
   HRlink, а также описывает процесс добавления взаимосвязей
     между заявлениями и документами для автоматизации
       кадрового документооборота.)
1.5 Сотрудники (Этот файл описывает функции и пошаговые инструкции
 по добавлению, редактированию, приглашению, увольнению и
   восстановлению сотрудников в системе HRlink, а также процесс
     выпуска и управления электронной подписью УНЭП, назначение
       руководителей, заместителей и настройку каналов уведомлений.)
1.6 Справочники (Этот файл содержит подробное описание ведения справочников
 (юрлица, отделы, должности, типы заявлений и документов) в
   системе HRlink, необходимых для автоматизации кадрового
     электронного документооборота; описываются связи этих
       справочников с процессами, инструкции по добавлению
         и редактированию объектов, настройке шаблонов заявлений
           и маршрутов согласования, а также автоматической подстановке
             падежных форм ФИО и должностей в документы.)
1.7 Настройки (Этот файл описывает раздел «Настройки» в системе HRlink,
 который позволяет управлять сроком действия подписки, перераспределять
   лицензии и оптимизировать расходы на SMS, а также содержит
     рекомендации и инструкции по изменению ролей сотрудников
       и альтернативным способам рассылки уведомлений.)
1.8 Обращения в службу заботы о клиентах (Этот файл содержит
 справочную информацию и инструкции по настройке и использованию
   различных функций HRlink: интеграции с Битрикс24, выгрузке архивов
     КЭДО, созданию гибких маршрутов согласования, настройке ролей,
       ограничений по сессиям, работе с удостоверяющими центрами,
         настройке всплывающих сообщений, управлению отпусками, переводу
           сотрудников, а также возможностям подписания документов
             с помощью различных видов электронной подписи.)
1.9 1C ЗУП 3.1: Модуль интеграции (Этот файл является подробной
 инструкцией по настройке, использованию и автоматизации
   интеграции между "1С:Зарплата и управление персоналом"
     (ЗУП) и сервисом HRlink — от передачи данных сотрудников
       до документов, обработки заявлений, формирования
         приказов и настройки регламентных заданий,
           включая автоматизацию планирования и учета отпусков,
             расчетных листков и документооборота.)
1.10 1С ЗУП 3.1 и 1С Fresh: ВПФ (Этот файл — подробная
 инструкция по установке и настройке внешней печатной формы
   (ВПФ) для интеграции данных между 1С:Зарплата и управление персоналом
     (ЗУП) и HRlink, включая процессы выгрузки сотрудников, документов,
       тегов и настройку маршрутов подписания, а также описание
         устранения типовых ошибок.)
1.11 1С ЗУП 2.5: ВПФ (Файл содержит подробную инструкцию по
 настройке обмена документами и данными о сотрудниках между
   1С:Зарплата и управление персоналом 2.5 и HRlink (например,
     сопоставление типов документов, организация подписания,
       выгрузка и отправка сотрудников), а также описывает
         передачу настроек другим пользователям системы.)
1.12 1C ЗУП 3.1: Расширение (Этот файл подробно описывает процесс
 установки, настройки и использования расширения для интеграции
 1С:ЗУП 3.1 с HRlink, включая автоматический и ручной обмен данными
   о сотрудниках и документах, настройку параметров выгрузки,
     фильтрацию, управление доступом и специфические алгоритмы
       обработки кадровых данных между системами.)
1.13 1С Бухгалтерия: Расширение для выгрузки авансового отчёта
(Этот файл содержит инструкцию по установке и настройке расширения
 для интеграции 1С Бухгалтерии с HRlink, позволяющего отправлять
   авансовые отчёты на подпись и отслеживать их статус
     непосредственно из 1С. Описаны пошаговые действия для
       подключения, авторизации, и отправки документов.)
1.14 FAQ по кадровым вопросам (Этот файл представляет собой
 FAQ по кадровым вопросам, связанным с хранением, подписанием
   и уничтожением электронных документов в системе HRlink/КЭДО,
     а также разъясняет сроки хранения разных видов
       кадровых документов и нюансы электронного документооборота.)
Администратор
2.1 Сотрудники (Этот файл содержит инструкцию по назначению
 ролей и прав в системе HRlink, описывает функции и ограничения
   для ролей сотрудников, руководителей, кадровиков
     и делопроизводителей, а также порядок их назначения
       и распределения полномочий для эффективного
         управления кадровыми процессами.)
2.2 Справочники (Этот файл представляет подробное руководство
 по работе с машиночитаемыми доверенностями (МЧД) и
   справочниками в системе HRlink: как создавать, редактировать
     и управлять МЧД (вручную и через импорт из файла),
       наделять полномочиями сотрудников, а также
         настраивать типы заявлений, типов документов и
           маршруты согласования для автоматизации
             кадровых и юридических процессов организации.)
2.3 График отпусков (Этот файл содержит инструкцию по
 ограничению права планирования и согласования отпусков
   в системе: ограничение может установить
   администратор, при этом только администратор
     и кадровик сохраняют эти права, а остальные
       сотрудники и руководители могут только
         просматривать график отпусков.)
2.4 Новости в HRlink Pro (Этот файл содержит инструкцию
 по использованию раздела "Новости" в HRlink Pro: описаны
   права разных ролей на создание, редактирование и чтение
     новостей, а также процесс добавления редакторов новостей
       и публикации сообщений для сотрудников компании.)
2.5 Настройки (Этот файл содержит инструкции для
 администраторов HRlink по настройке видимости данных профиля
   сотрудников, настройке повторных уведомлений о
     необходимости подписать документы, добавлению
       контактных данных отдела кадров для сотрудников,
         а также по редактированию и наполнению
           главной страницы портала компании виджетами сервисов.)
2.6 Прочие действия (Этот файл содержит инструкции
 по регистрации и интеграции организации с
   порталом "Работа в России" через ЕСИА, а
     также технические требования для
       работы и установки on-premises версии HRlink.)
Сотрудник
3.1 Страница авторизации (Файл содержит подробное
 руководство по регистрации, авторизации,
 восстановлению пароля и настройке двухфакторной
   аутентификации для пользователей системы кадрового
     электронного документооборота HRlink через
       приглашение по email или SMS.)
3.2 Личный кабинет (Файл содержит подробную инструкцию
 по выпуску и использованию усиленной неквалифицированной
   электронной подписи (УНЭП) через личный кабинет
     HRlink, включая процедуры очной и удалённой идентификации,
       порядок получения и смены каналов для одноразовых кодов,
         а также подключение Telegram-бота для уведомлений
           и подписания документов.)
3.3 Документы (Файл содержит подробную инструкцию по подписанию
 кадровых документов в системе HRlink разными способами
   (УНЭП, ПЭП, Госключ, ЕСИА), а также описывает порядок
     получения уведомлений, скачивания архива документооборота
       и работы с комментариями и внешними порталами,
         такими как "Работа в России" и Госуслуги.)
3.4 Заявления (Этот файл содержит подробную инструкцию по
 подаче, подписанию, отслеживанию, редактированию и
   удалению электронных заявлений в системе HRlink, а также
     описывает доступные способы подачи, работу с черновиками
       и процесс согласования заявлений с использованием
         разных видов электронной подписи.)
3.5 Главная страница (Этот файл содержит информацию о
 главной странице портала, на которой размещены
   настраиваемые администратором виджеты с ссылками
     на внутренние и внешние сервисы компании, а также
     держит инструкции по отзыву и проверке сертификата
       электронной подписи (УНЭП), а также ответы на частые
         вопросы о безопасности, использовании электронной
           подписи и персональных данных в HRlink,
             включая процедуры при увольнении,
               компрометации ключа и общие
                 меры по защите данных.)
3.7 Прочие действия (Этот файл содержит подробные
 инструкции по созданию ярлыка для быстрого доступа
   к порталу HRlink на различных устройствах и в
     разных браузерах, а также описывает шаги по
       проверке электронных подписей на документах
         и способы очистки кэша и файлов cookie
           в популярных браузерах и операционных
             системах.)
3.8 Приложение HRlink: установка и авторизация
 (Этот файл содержит пошаговую инструкцию
 по установке и авторизации в мобильном
   приложении HRlink на устройствах
     Android и iPhone, а также описывает
       основные функции и навигацию по приложению.)
Подписант от юрлица
4.1 Личный кабинет (Этот файл содержит
 инструкцию по настройке уведомлений в
   личном кабинете, чтобы получать информацию
     о документах, ожидающих подписи, в удобное
       время либо агрегированным сообщением,
         либо совсем отключить уведомления.)
4.2 Документы (Этот файл описывает пошаговые
 инструкции для подписания документов с помощью
   усиленной квалифицированной электронной
     подписи (УКЭП) — как по индивидуальной
       ссылке из уведомления, так и массово
         из реестра документов руководителя.
           В нем указаны предварительные условия,
             последовательность действий и
               результат подписания.)
4.3 УКЭП (Этот файл содержит инструкции по
 установке и использованию программного
   обеспечения для работы с электронной
     подписью (УКЭП), а также по просмотру
       и экспорту открытого ключа сертификата
         на Windows, macOS и Linux —
         с описанием типовых ошибок и
           способов их устранения.)
4.4 Заместители (Этот файл содержит
 подробные инструкции для руководителей
   и участников деловых процессов о
     том, как назначать и удалять
     заместителей на период отсутствия,
       описывает порядок действий и
         особенности замещения в
           корпоративной системе.)

6.1 Согласовать график отпусков (Этот
 файл содержит подробную инструкцию
   по процессу планирования, согласования
     и выгрузки графика отпусков в HR-системе
       с интеграцией в 1С, включая
         права и действия сотрудников,
           руководителей, кадровиков и
             администраторов. Описаны
               все этапы — от настройки
                 прав на планирование и
                   передачи остатков отпусков
                     из 1С до утверждения, корректировки
                     и уведомления сотрудников о графике отпусков.
6.2 Видеоуроки
6.3 Обучающие вебинары
(Этот файл представляет собой программу обучающих вебинаров по
 использованию функционала системы HRlink и интеграции с 1С,
   а также описание новых возможностей, обновлений и релизов
     сервиса — для сотрудников, HR-специалистов и администраторов.
       В документе подробно указаны темы обучения, даты, функционал,
         охваченный на сессиях, и короткие анонсы прошедших и будущих
           обновлений платформы.)
6.4 Процесс подключения ПРР сотруднику (Этот файл содержит пошаговую
 инструкцию для кадровика, руководителя и сотрудника по подключению
   электронной подписи ПЭП Госуслуги для работы на портале Работа России
     (ПРР), включая действия в кадровой системе и на самом портале.)


Start Link - это отдельный продукт

7.1 Кандидаты Start Link (Этот файл — подробная инструкция по
 работе с реестром кандидатов в системе Start Link. В нем описано,
   как использовать и настраивать фильтры при поиске кандидатов,
     добавлять и импортировать кандидатов, назначать ответственных,
       приглашать кандидатов и запрашивать у них документы,
         а также проводить проверки на благонадежность, добавлять
           теги и статусы, указывать причины отказа и работать с
             данными кандидатов на всех этапах подбора.)
7.2 1С: Обработка Start Link (Этот файл содержит инструкцию по установке,
 обновлению и использованию обработки интеграции Start Link с 1С для
   автоматического переноса данных кандидатов и оформления их в качестве
     сотрудников, а также передачу адресов, банковских реквизитов и настройку
       сопоставления полей для пользователей. Также описаны требования к
       платформе 1С, процесс авторизации через API-токен и предотвращение
         создания дублей сотрудников при импорте.)
7.3 Шаблоны запроса Start Link (Этот файл содержит пошаговую инструкцию
 по созданию, редактированию и использованию шаблонов запроса документов
   в системе Start Link для кадровиков, чтобы автоматизировать сбор документов
     от кандидатов и интеграцию их данных в 1С.
       Описаны настройки распознавания,
       необходимости документов, добавления анкет и согласий, а также
         возможность копирования шаблонов для разных вакансий.)
7.4 Шаблоны анкет Start Link (Этот файл содержит подробную инструкцию
 по созданию, редактированию, копированию и удалению шаблонов
   анкет для сбора информации от кандидатов в системе Start
     Link, а также описывает преимущества использования
       встроенного конструктора анкет.)
7.5 Города Start Link (Файл содержит инструкцию по добавлению
 городов в справочник системы, выбору города для
   кандидата и использованию фильтра по городу для отбора
     кандидатов, а также описывает правила проверки
       городов на дублирование.)
7.6 Обращения в Службу заботы о клиентах Start Link (Файл
 содержит инструкции по настройке и индивидуализации работы
   сервиса Start Link через обращения в службу поддержки: подключение SSO,
     интеграции, настройка сроков и шаблонов, согласий и обработки
     персональных данных, а также изменение функционала по запросу клиента.
     Интеграцию с Huntflow)

8.1 Кандидаты Start Link (Этот файл содержит описание
 процесса удаления кандидатов и их персональных данных из системы:
   владелец может самостоятельно удалить одного или нескольких кандидатов
     вместе со всеми связанными документами, а также скачать акт
       об уничтожении персональных данных.)
8.2 Юридические лица Start Link (Этот файл содержит инструкцию
 по работе со справочником юридических лиц в системе Start Link:
   как добавлять и настраивать юридические лица, как назначать
     пользователей для работы с конкретными юрлицами и как распределять
       кандидатов между ними.)
8.3 Пользователи Start Link (Этот файл содержит
 инструкцию по добавлению и приглашению новых пользователей на
   портал Start Link, а также по назначению им ролей и редактированию
     их доступа к юридическим лицам. Описаны шаги создания пользователя,
       выбор каналов связи, отправка и отмена приглашения.)
8.4 Акты уничтожения ПДн Start Link (Этот файл описывает процесс
 формирования и скачивания актов уничтожения персональных данных
   кандидатов после их удаления из системы, а также способы
   поиска и выбора нужных актов для отчёта.)

9.1 Кандидаты Start Link (Этот файл описывает порядок
 проверки кандидатов на благонадежность в системе Start Link:
   автоматическую (с отображением результата в виде светофора)
     и ручную (с установкой статуса сотрудником службы безопасности),
       а также дальнейшие действия по работе с кандидатами
         и управлению их статусами.)
10.1 FAQ Start Link (Этот файл содержит ответы на часто задаваемые
 вопросы по системе Start Link, касающиеся интеграций с ATS, работы
   с анкетами, лицензирования, проверки данных кандидатов,
     SSO-авторизации и других функциональных возможностей сервиса.)
11.1 Технические требования on-premises Start Link (Этот файл содержит
 технические требования для установки системы Start Link on-premises,
   включая необходимые параметры сервера и информацию по
     хранению файлов кандидатов.)
12.1 Кандидат Start Link (Этот файл содержит пошаговую инструкцию
 для кандидатов по регистрации и заполнению шаблона запроса
   документов на портале Start Link: от принятия приглашения,
     подтверждения данных и подписи согласий, до заполнения анкеты,
       загрузки требуемых документов и ожидания проверки со
         стороны кадрового специалиста.)

ВАЖНО, используй ТОЛЬКО для выделерния текста ЖИРНЫМ <b>text</b>
Вопрос: {question}"""

        response = await client.chat.completions.create(
            model="deepseek-chat",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.1,
            max_tokens=5000
        )
        section = response.choices[0].message.content.strip()
        return section if '.' in section else None

    except Exception as e:
        logger.error(f"Ошибка классификации: {e}")
        return None
